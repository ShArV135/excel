{% extends 'base.html.twig' %}

{% set page_header = null %}
{% set page_title = timetable.name %}

{% block body %}
    <div class="clearfix" style="margin: 10px 0;">
        <div class="timetable-toolbar btn-toolbar pull-left">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success selectable-start">Выделить путевые</button>
                <button type="button" class="btn hidden selectable-color red" data-color="red">&nbsp;</button>
                <button type="button" class="btn hidden selectable-color green" data-color="green">&nbsp;</button>
                <button type="button" class="btn hidden selectable-color blue" data-color="blue">&nbsp;</button>
                <button type="button" class="btn hidden selectable-color" data-color="no-color">&nbsp;</button>
                <button type="button" class="btn btn-default selectable-close hidden">
                    <span class="glyphicon glyphicon-ok"></span>
                </button>
            </div>
        </div>
        <div class="btn-group pull-right" role="group">
            <a class="btn btn-primary" href="{{ path('timetable_row_create') }}">
                Добавить запись
            </a>
            {% if is_granted('ROLE_GENERAL_MANAGER') %}
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Изменить вид
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="{{ path('homepage') }}">Обычный</a></li>
                    <li><a href="{{ path('homepage', {'show': 'customer_manager'}) }}">Менеджер по продажам</a></li>
                    <li><a href="{{ path('homepage', {'show': 'provider_manager'}) }}">Менеджер по снабжению</a></li>
                    <li><a href="{{ path('homepage', {'show': 'dispatcher'}) }}">Диспетчер</a></li>
                    <li><a href="{{ path('homepage', {'show': 'all'}) }}">Показать всё</a></li>
                </ul>
                <a class="btn btn-danger"
                   onclick="deleteConfirm('{{ path('timetable_delete', {'timetable': timetable.id}) }}')"
                   href="javascript: void(0)"
                >
                    Удалить табель
                </a>
            {% endif %}
        </div>
    </div>
    <div id="timetable_container" class="row" style="margin: 10px 0 0;">
        <table id="timetable" class="timetable">
            <thead>
            <tr>
                <th class="timetable-fixed-cell controls">&nbsp;</th>
                {% for column in columns %}
                    {% set class = column %}
                    {% if column in fixed_columns %}
                        {% set class = class ~ ' timetable-fixed-cell' %}
                    {% endif %}
                    {% if column == 'manager' %}
                        <th data-field="manager" data-filter-control="input" class="{{ class }}">Менеджер</th>
                    {% elseif column == 'customer' %}
                        <th data-field="customer" data-filter-control="input" class="{{ class }}">Заказчик</th>
                    {% elseif column == 'provider' %}
                        <th data-field="provider" data-filter-control="input" class="{{ class }}">Поставщик</th>
                    {% elseif column == 'object' %}
                        <th data-field="object" data-filter-control="input" class="{{ class }}">Объект</th>
                    {% elseif column == 'mechanism' %}
                        <th data-field="mechanism" data-filter-control="input" class="{{ class }}">Механизм</th>
                    {% elseif column == 'comment' %}
                        <th data-field="comment" data-filter-control="input" class="{{ class }}">Комментарий</th>
                    {% elseif column == 'price_for_customer' %}
                        <th class="{{ class }}">Цена<br>заказчику<br>маш/ч</th>
                    {% elseif column == 'price_for_provider' %}
                        <th class="{{ class }}">Цена<br>поставщика<br>маш/ч</th>
                    {% elseif column == 'sum_times' %}
                        <th class="{{ class }}">Сумма<br>часов</th>
                    {% elseif column == 'times' %}
                        {% for i in 1..31 %}
                            <th class="{{ class ~ (i == 16 ? ' bold-border' : '') }}">{{ i }}</th>
                        {% endfor %}
                    {% elseif column == 'customer_salary' %}
                        <th class="{{ class }}">Наработка<br>заказчика</th>
                    {% elseif column == 'provider_salary' %}
                        <th class="{{ class }}">Наработка<br>поставщика</th>
                    {% elseif column == 'customer_paid' %}
                        <th class="{{ class }}">Оплачено<br>заказчиком</th>
                    {% elseif column == 'customer_balance' %}
                        <th class="{{ class }}">Баланс<br>заказчика</th>
                    {% elseif column == 'provider_paid' %}
                        <th class="{{ class }}">Оплачено<br>поставщику</th>
                    {% elseif column == 'provider_balance' %}
                        <th class="{{ class }}">Баланс<br>поставщика</th>
                    {% elseif column == 'margin_sum' %}
                        <th class="{{ class }}">Маржа,<br>сумма</th>
                    {% elseif column == 'margin_percent' %}
                        <th class="{{ class }}">Маржа,<br>%</th>
                    {% endif %}
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% set tmpCustomer = '' %}
            {% for row in rows %}
                <tr data-row="{{ row.id }}"
                    data-customer-id="{{ row.customer_id }}"
                    data-provider-id="{{ row.provider_id }}"
                    class="{{ (tmpCustomer and tmpCustomer != row.customer) ? 'bold-border' : '' }}"
                >
                    <td>
                        <a href="{{ path('timetable_row_update', {'timetable': timetable.id, 'timetableRow': row.id}) }}">
                            <span class="glyphicon glyphicon-edit"></span>
                        </a>
                        <a class="delete-confirm"
                           onclick="deleteConfirm('{{ path('timetable_row_delete', {'timetable': timetable.id, 'timetableRow': row.id}) }}')"
                           href="javascript: void(0)"
                        >
                            <span class="glyphicon glyphicon-remove"></span>
                        </a>
                    </td>
                    {% for column in columns %}
                        {% if column == 'manager' %}
                            <td><div class="tt-tooltip" title="{{ row.manager }}">{{ row.manager }}</div> </td>
                        {% elseif column == 'customer' %}
                            <td><div class="tt-tooltip" title="{{ row.customer }}">{{ row.customer }}</div> </td>
                        {% elseif column == 'provider' %}
                            <td><div class="tt-tooltip" title="{{ row.provider }}">{{ row.provider }}</div> </td>
                        {% elseif column == 'object' %}
                            <td><div class="tt-tooltip" title="{{ row.object }}">{{ row.object }}</div> </td>
                        {% elseif column == 'mechanism' %}
                            <td><div class="tt-tooltip" title="{{ row.mechanism }}">{{ row.mechanism }}</div> </td>
                        {% elseif column == 'comment' %}
                            <td><div class="tt-tooltip" title="{{ row.comment }}">{{ row.comment }}</div> </td>
                        {% elseif column == 'price_for_customer' %}
                            <td>{{ row.price_for_customer }}</td>
                        {% elseif column == 'price_for_provider' %}
                            <td>{{ row.price_for_provider }}</td>
                        {% elseif column == 'sum_times' %}
                            <td data-sum_times>{{ row.sum_times }}</td>
                        {% elseif column == 'times' %}
                            {% for day, time in row.times.times %}
                                <td class="times {{ row.times.colors[day]|default }} {{ (day == 16 ? 'bold-border' : '') }}"
                                    data-id="{{ row.times.id }}"
                                    data-day="{{ day }}"
                                >
                                    <div class="times-item hidden">
                                        {{ time }}
                                    </div>
                                    <input class="times-input"
                                           type="text"
                                           data-value="{{ time }}"
                                           value="{{ time }}"
                                    />
                                    <a class="times-comment {{ row.times.comments[day]|length ? 'text-danger' : '' }}"
                                       data-type="textarea"
                                       data-pk="{{ row.times.id }}"
                                       data-name="{{ day }}"
                                       data-url="{{ path('timetable_row_times_update_comment', {'timetableRowTimes': row.times.id}) }}"
                                       data-value="{{ row.times.comments[day] }}"
                                    >
                                        <span class="glyphicon glyphicon-certificate"></span>
                                    </a>
                                </td>
                            {% endfor %}
                        {% elseif column == 'customer_salary' %}
                            <td data-customer_salary>{{ row.customer_salary }}</td>
                        {% elseif column == 'provider_salary' %}
                            <td data-provider_salary>{{ row.provider_salary }}</td>
                        {% elseif column == 'customer_paid' %}
                            <td data-customer_paid>{{ row.customer_paid }}</td>
                        {% elseif column == 'customer_balance' %}
                            {% set class = row.customer_balance < 0 ? 'bg-right text-white' : '' %}
                            <td data-customer_balance class="{{ class }}">{{ row.customer_balance }}</td>
                        {% elseif column == 'provider_paid' %}
                            <td data-provider_paid>{{ row.provider_paid }}</td>
                        {% elseif column == 'provider_balance' %}
                            {% set class = row.provider_balance < 0 ? 'bg-pink' : '' %}
                            <td data-provider_balance class="{{ class }}">{{ row.provider_balance }}</td>
                        {% elseif column == 'margin_sum' %}
                            <td data-margin_sum>{{ row.margin_sum }}</td>
                        {% elseif column == 'margin_percent' %}
                            <td data-margin_percent>{{ row.margin_percent }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% set tmpCustomer = row.customer %}
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block stylesheets %} {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/timetable.css') }}">
{% endblock %}

{% block javascripts %} {{ parent() }}
    <script>
        $(function() {
            var height = $('#timetable_container').height()+100;
            var offset = $('#timetable_container').offset();
            var maxHeight = $(window).height() - offset.top;
            if (height > maxHeight) {
                height = maxHeight;
            }

            $('.timetable').bootstrapTable({
                fixedColumns: true,
                fixedNumber: {{ num_of_fixed }},
                filterControl: true,
                height: height
            });

            $('.tt-tooltip').tooltip({
                trigger: 'click',
                container: 'body'
            });

            $('.timetable .times-input').blur(function() {
                var $input = $(this);
                var $td = $input.parent('td');
                var $tr = $input.closest('tr');

                var id = $td.data('id');
                var day = $td.data('day');
                var oldValue = $input.data('value');
                var value = $input.val();

                if (value == '') {
                    $input.val(oldValue);
                    return;
                }

                if (value == oldValue) {
                    return;
                }

                var rowId = $tr.data('row');
                var customerId = $tr.data('customer-id');
                var providerId = $tr.data('provider-id');
                var $trById = $('[data-row="' + rowId + '"]');
                var $trByCustomer = $('[data-customer-id="' + customerId + '"]');
                var $trByProvider = $('[data-provider-id="' + providerId + '"]');

                $.ajax({
                    type: 'POST',
                    url: Routing.generate('timetable_row_times_update', {'timetableRowTimes': id}),
                    data: {
                        day: day,
                        value: value
                    },
                    beforeSend: function() {
                        $('.timetable .times-input').attr('disabled', 'disabled');
                    },
                    success: function(response) {
                        if (response.status === 'OK') {
                            $input.data('value', value);

                            var data = response.data;

                            $('[data-sum_times]', $trById).text(data.sum_times);
                            $('[data-customer_salary]', $trById).text(data.customer_salary);
                            $('[data-provider_salary]', $trById).text(data.provider_salary);
                            $('[data-margin_sum]', $trById).text(data.margin_sum);
                            $('[data-margin_percent]', $trById).text(data.margin_percent);
                            $('[data-customer_balance]', $trByCustomer).text(data.customer_balance);
                            $('[data-provider_balance]', $trByProvider).text(data.provider_balance);
                            $('[data-customer_paid]', $trByCustomer).text(data.customer_paid);
                            $('[data-provider_paid]', $trByProvider).text(data.provider_paid);

                            $item = $input.prev('div.times-item');
                            $item.text(value);
                        } else {
                            $input.val(oldValue);
                        }
                    },
                    error: function () {
                        $input.val(oldValue);
                    },
                    complete: function() {
                        $('.timetable .times-input').removeAttr('disabled');
                    }
                });
            });

            $('.timetable .times-comment').editable({
                container: 'body',
                display: function() {
                    return '';
                },
                success : function (response, newValue) {
                    if (newValue == '') {
                        $(this).removeClass('text-danger');
                    } else {
                        $(this).addClass('text-danger');
                    }
                }
            });

            $('#timetable').selectable({
                filter: 'div.times-item'
            });

            $('.selectable-start').click(function() {
                $(this).addClass('hidden');
                $(this).nextAll('.btn').removeClass('hidden');

                $('.timetable .times-input').addClass('hidden');
                $('.timetable .times-item').removeClass('hidden');
            });

            $('.selectable-close').click(function() {
                $(this).addClass('hidden');
                $(this).prevAll('.btn').addClass('hidden');
                $('.selectable-start').removeClass('hidden');

                $('.timetable .times-input').removeClass('hidden');
                $('.timetable .times-item').addClass('hidden');
            });

            $('.selectable-color').click(function() {
                var $selected = $('.times-item.ui-selected'),
                    color = $(this).data('color'),
                    data = []
                ;
                $selected.each(function(i) {
                    var $td = $(this).parent('td');

                    data[i] = {
                        id: $td.data('id'),
                        day: $td.data('day'),
                    };
                });

                $.ajax({
                    type: 'POST',
                    url: Routing.generate('timetable_row_times_update_colors', {color: color}),
                    data: {
                        data: data
                    },
                    beforeSend: function() {
                        $('#timetable').selectable('disable');
                        $('.selectable-color').attr('disabled', 'disabled');
                    },
                    success: function(response) {
                        $selected.removeClass('ui-selected');
                        $selected.parent('td').removeClass('red green blue');
                        if (color !== 'no-color') {
                            $selected.parent('td').addClass(color);
                        }
                    },
                    complete: function() {
                        $('#timetable').selectable('enable');
                        $('.selectable-color').removeAttr('disabled');
                    }
                });
            });
        });
    </script>
{% endblock %}

