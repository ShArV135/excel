{% extends 'base.html.twig' %}
{% import _self as macros %}

{% set page_title = 'Отчет по менеджерам' %}

{% macro manager_report(report, i) %}
    {% set summary_data = report.summary_data %}
    {% set customer_manager_data = report.customer_manager_data %}
    {% set provider_manager_data = report.provider_manager_data %}
    {% set provider_data = report.provider_data %}
    {% set i = i|default(0) %}

    <div class="row">
        <ul class="nav nav-pills" style="margin: 10px;">
            <li class="active"><a data-toggle="pill" href="#customer_manager-{{ i }}">Менеджеры по продажам</a></li>
            <li><a data-toggle="pill" href="#provider_manager-{{ i }}">Менеджеры по снабжению</a></li>
        </ul>
        <div class="tab-content">
            <div id="customer_manager-{{ i }}" class="tab-pane fade in active">
                <table class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th>ФИО</th>
                        <th class="col-md-1">Заказчиков</th>
                        <th class="col-md-1">Выполнение<br>плана продаж</th>
                        <th class="col-md-1">Наработка</th>
                        {% if is_granted('ROLE_GENERAL_MANAGER') %}
                            <th class="col-md-1">Маржа</th>
                        {% endif %}
                        <th class="col-md-1">Маржа, %</th>
                        <th class="col-md-2">Сумма предоплат (за все время)</th>
                        <th class="col-md-2">Сумма задолженностей (за все время)</th>
                    </tr>
                    {% if summary_data %}
                        <tr>
                            <th colspan="2" style="text-align: right">Всего:</th>
                            <th class="nowrap">{{ summary_data.plan_completed_percent~'%' }}</th>
                            <th class="nowrap">{{ summary_data.salary|number_format(2, '.', ' ') }}</th>
                            {% if is_granted('ROLE_GENERAL_MANAGER') %}
                                <th class="nowrap">{{ summary_data.margin_sum|number_format(2, '.', ' ') }}</th>
                            {% endif %}
                            <th class="nowrap">{{ summary_data.margin_percent|number_format(2, '.', ' ') }}</th>
                            <th colspan="2">&nbsp;</th>
                        </tr>
                    {% endif %}
                    </thead>
                    <tbody>
                    {% for customer_row in customer_manager_data %}
                        <tr>
                            <td>{{ customer_row.fio }}</td>
                            <td>{{ customer_row.customers }}</td>
                            <td class="nowrap">{{ customer_row.plan_completed_percent~'%' }}</td>
                            <td class="nowrap">{{ customer_row.salary|number_format(2, '.', ' ') }}</td>
                            {% if is_granted('ROLE_GENERAL_MANAGER') %}
                                <td class="nowrap">{{ customer_row.margin_sum|number_format(2, '.', ' ') }}</td>
                            {% endif %}
                            <td class="nowrap">{{ customer_row.margin_percent|number_format(2, '.', ' ') }}</td>
                            <td class="nowrap">{{ customer_row.balance_positive|number_format(2, '.', ' ') }}</td>
                            <td class="nowrap">{{ customer_row.balance_negative|number_format(2, '.', ' ') }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>

                </table>
            </div>
            <div id="provider_manager-{{ i }}" class="tab-pane fade">
                {% if provider_data %}
                    <table class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>Наработка</th>
                            <th>Сумма предоплат (за все время)</th>
                            <th>Сумма задолженностей (за все время)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="nowrap">{{ provider_data.salary|number_format(2, '.', ' ') }}</td>
                            <td>{{ provider_data.balance_positive|number_format(2, '.', ' ') }}</td>
                            <td>{{ provider_data.balance_negative|number_format(2, '.', ' ') }}</td>
                        </tr>
                        </tbody>
                    </table>
                    <table class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Наработка</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for provider_row in provider_manager_data %}
                            <tr>
                                <td>{{ provider_row.fio }}</td>
                                <td class="nowrap">{{ provider_row.salary|number_format(2, '.', ' ') }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}

{% block body %}
    <div class="container">
        <div class="page-header">
            <h2>{{ page_title }}</h2>
        </div>
        <div class="row">
            {{ form_start(timetable_filter, {'attr': {'class': 'form-inline'}}) }}
            {{ form_rest(timetable_filter) }}
            <button class="btn btn-primary form-control" type="submit">Показать</button>
            {{ form_end(timetable_filter) }}
        </div>
        {% if report %}
            {{ macros.manager_report(report) }}
        {% endif %}
        {% if report_by_organisations %}
            {% for i, report_by_organisation in report_by_organisations %}
                <h3>{{ report_by_organisation.organisation.name }}</h3>
                {{ macros.manager_report(report_by_organisation.report, i) }}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block stylesheets %} {{ parent() }}
    <style>
        table .nowrap {
            white-space: nowrap;
        }
    </style>
{% endblock %}